<script>
  let targetAngle = 0;
  let currentAngle = 0;
  let lastRawAngle = null;
  let ratchetBase = 0;
  let ratchetThreshold = 3;

  document.getElementById('startBtn').addEventListener('click', () => {
    targetAngle = parseFloat(document.getElementById('targetAngle').value);
    currentAngle = 0;
    lastRawAngle = null;
    ratchetBase = 0;
    document.getElementById('status').textContent = "Tracking started...";
    requestSensorAccess();
  });

  function requestSensorAccess() {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission().then(response => {
        if (response === 'granted') {
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert("Permission denied for motion sensors.");
        }
      }).catch(() => {
        alert("Sensor access failed.");
      });
    } else {
      window.addEventListener('devicemotion', handleMotion);
    }
  }

  function handleMotion(event) {
    const gamma = event.rotationRate.gamma;
    if (gamma === null) return;

    if (lastRawAngle === null) {
      lastRawAngle = gamma;
      return;
    }

    // Clockwise rotation adds to angle
    if (gamma > 0) {
      currentAngle += gamma * 0.02;
    }

    // Anti-clockwise movement beyond threshold → lock in new base
    if (gamma < -ratchetThreshold) {
      ratchetBase = currentAngle;
      document.getElementById('status').textContent = `🔁 Ratchet locked at ${ratchetBase.toFixed(1)}°`;
    }

    // Continue counting from ratchet base
    const displayAngle = currentAngle - ratchetBase;

    document.getElementById('needle').style.transform = `rotate(${displayAngle}deg)`;

    if (displayAngle >= targetAngle) {
      document.getElementById('status').textContent = `✅ Target reached: ${displayAngle.toFixed(1)}°`;
    } else {
      document.getElementById('status').textContent = `🔄 Current angle: ${displayAngle.toFixed(1)}°`;
    }

    lastRawAngle = gamma;
  }
</script>
